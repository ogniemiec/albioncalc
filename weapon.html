<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>CRAFT CALCULATOR — Auto ceny z AODP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --bg:#1a1a1a; --panel:#222; --panel2:#333; --txt:#f0f0f0; --acc:#4CAF50; --accent2:#2196F3; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
           background: var(--bg); color: var(--txt); margin:0; }
    header { background: var(--panel2); padding: 1rem; text-align:center; position: relative; }
    main { padding: 1rem; max-width: 1100px; margin: auto; }
    section { background: var(--panel); padding: 1rem; margin: 1rem 0; border-radius: 10px; }
    label { display:block; margin: .6rem 0 .25rem; }
    input, select { width: 100%; padding: .55rem .65rem; border: none; border-radius: 6px; background: #111; color: var(--txt); }
    button { margin-top: 1rem; padding: .7rem .9rem; background: var(--acc); color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { filter: brightness(1.05); }
    h1,h2 { margin: .2rem 0 .6rem; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 1rem; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    .results { margin-top: 1.2rem; }
    .result-box { margin-bottom: 1rem; padding: 1rem; background: var(--panel2); border-radius: 10px; white-space: pre-line; }
    .muted { color:#cfcfcfcc; font-size: .95rem; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
    .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#444; font-size:.8rem; }
    .ok { background:#2e7d32; }
    .warn { background:#8d6e00; }
    .err { background:#7b1fa2; }
    .statusbar { display:flex; align-items:center; gap:.6rem; font-size:.95rem; flex-wrap:wrap; }
    progress { width:230px; height: 10px; accent-color: var(--acc); }
    code.inline { background:#111; padding:.1rem .3rem; border-radius:6px; }
    .swap-btn { position:absolute; top:12px; right:12px; padding:.4rem .7rem; background:var(--accent2); color:#fff; border:none; border-radius:8px; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    .swap-btn:hover { filter:brightness(1.05); }
    footer.note { text-align:center; color:#bdbdbd; font-size:.9rem; margin-top:1rem; }
  </style>
</head>
<body>
  <header>
    <h1>CRAFT CALCULATOR — AUTO PRICES (WEAPONS & OFFHANDS)</h1>
    <div class="muted" id="subheader">Ładowanie cen…</div>
    <button class="swap-btn" onclick="window.location.href='index.html'">BACK TO CRAFT SELECT</button>
  </header>

  <main>
    <section id="price-source">
      <h2>API Source:</h2>
      <div class="statusbar">
        <span>Server API: <code class="inline">europe.albion-online-data.com</code></span>
        <span>•</span>
        <span>City bonuses: Planks→Fort Sterling, Bars→Thetford, Leather→Martlock, Cloth→Lymhurst</span>
      </div>
      <div class="row" style="margin-top:.6rem;">
        <button id="refresh">Refresh prices</button>
        <span id="load-status" class="badge">Nie rozpoczęto</span>
        <progress id="load-progress" max="1" value="0"></progress>
        <span id="last-updated" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:.6rem;">
        If the bar doesn't say <strong>100/100</strong> refresh the site <strong>if that won't help</strong>, wait some time and try again.
      </p>
    </section>

    <section id="form-section">
      <h2>Choose an item:</h2>
      <div class="grid">
        <div>
          <label for="item">Item name</label>
          <select id="item"></select>
        </div>
        <div>
          <label for="tier">Item tier</label>
          <select id="tier">
            <option value="4">T4</option>
            <option value="5">T5</option>
            <option value="6">T6</option>
            <option value="7">T7</option>
            <option value="8">T8</option>
          </select>
        </div>
        <div>
          <label for="enchant">Item enchant</label>
          <select id="enchant">
            <option value="0">.0</option>
            <option value="1">.1</option>
            <option value="2">.2</option>
            <option value="3">.3</option>
            <option value="4">.4</option>
          </select>
        </div>
        <div>
          <label for="price">Price your item sells for</label>
          <input type="number" id="price" placeholder="example. 100000" />
        </div>
        <div>
          <label for="amount">Quantity</label>
          <input type="number" id="amount" value="1" min="1" />
        </div>
        <div>
          <label for="returnRate">Return rate (%)</label>
          <input type="number" id="returnRate" min="0" max="100" placeholder="example. 25" />
        </div>
      </div>
      <button id="calculate">CALCULATE</button>
    </section>

    <section id="results" class="results">
      <h2>RESULTS</h2>
      <div class="result-box" id="craft-result">
        <h3>CRAFT COST</h3>
        <p id="craft-text">Result will show after pressing „CALCULATE”.</p>
      </div>
      <div class="result-box" id="profit-result">
        <h3>PROFIT / LOSS</h3>
        <p id="profit-text">Result will show after pressing „CALCULATE”.</p>
      </div>
    </section>

    <footer class="note">Open both files (index.html / armor.html) from the same folder to use the swap button.</footer>
  </main>

  <script>
    const API_HOST = "https://europe.albion-online-data.com";
    const materialCities = {
      planks: "Fort Sterling",
      bars: "Thetford",
      leather: "Martlock",
      cloth: "Lymhurst",
    };
    const MATERIAL_BASE_ID = {
      planks: "PLANKS",
      bars: "METALBAR",
      leather: "LEATHER",
      cloth: "CLOTH",
    };
    const TIERS = [4, 5, 6, 7, 8];
    const ENCHANTS = [0, 1, 2, 3, 4];

const itemsData = {
  "Arcanes"
"1H Arcane": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Great Arcane": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Enigmatic": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Battleaxe": { mats: [{ type: "planks", qty: 8 }, { type: "bars", qty: 16 }] },
"Greataxe": { mats: [{ type: "planks", qty: 12 }, { type: "bars", qty: 20 }] },
"Halberd": { mats: [{ type: "planks", qty: 12 }, { type: "bars", qty: 20 }] },
"Bow": { mats: [{ type: "planks", qty: 32 }] },
"Warbow": { mats: [{ type: "planks", qty: 32 }] },
"Longbow": { mats: [{ type: "planks", qty: 32 }] },
"Crossbow": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Heavy crossbow": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Light crossbow": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Cursed staff": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Great cursed staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Demonic staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Dagger": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 12 }] },
"Daggerpair": { mats: [{ type: "bars", qty: 16 }, { type: "leather", qty: 16 }] },
"Claws": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Fire staff": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Great fire staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Infernal staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Frost staff": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Great frost staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Glacial staff": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"1H Hammer": { mats: [{ type: "bars", qty: 24 }] },
"Polehammer": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"Great Hammer": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"1H Holy": { mats: [{ type: "bars", qty: 16 }, { type: "cloth", qty: 8 }] },
"Great Holy Staff": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"Divine staff": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"Brawler gloves": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Spiked gauntlets": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Battle bracers": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"1H Mace": { mats: [{ type: "bars", qty: 16 }, { type: "cloth", qty: 8 }] },
"Heavy Mace": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"Morningstar": { mats: [{ type: "bars", qty: 20 }, { type: "cloth", qty: 12 }] },
"Nature staff": { mats: [{ type: "planks", qty: 16 }, { type: "cloth", qty: 8 }] },
"Great nature staff": { mats: [{ type: "planks", qty: 20 }, { type: "cloth", qty: 12 }] },
"Wild nature staff": { mats: [{ type: "planks", qty: 20 }, { type: "cloth", qty: 12 }] },
"Quarterstaff": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Ironclad staff": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Doublebladed staff": { mats: [{ type: "bars", qty: 12 }, { type: "leather", qty: 20 }] },
"Spear": { mats: [{ type: "planks", qty: 16 }, { type: "bars", qty: 8 }] },
"Pike": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Glaive": { mats: [{ type: "planks", qty: 20 }, { type: "bars", qty: 12 }] },
"Broadsword": { mats: [{ type: "bars", qty: 16 }, { type: "leather", qty: 8 }] },
"Claymore": { mats: [{ type: "bars", qty: 20 }, { type: "leather", qty: 12 }] },
"Dual swords": { mats: [{ type: "bars", qty: 20 }, { type: "leather", qty: 12 }] },
"Offhand Torch": { mats: [{ type: "planks", qty: 4 }, { type: "leather", qty: 4 }] },
"Offhand Shield": { mats: [{ type: "planks", qty: 4 }, { type: "bars", qty: 4 }] },
"Offhand Tome": { mats: [{ type: "planks", qty: 4 }, { type: "cloth", qty: 4 }] },
"Offhand Orb": { mats: [{ type: "bars", qty: 4 }, { type: "cloth", qty: 4 }] }
};

    const materialsPrices = { planks: {}, bars: {}, leather: {}, cloth: {} };
    let lastUpdatedAt = null;
    function toPL(n) { return Number(n).toLocaleString('pl-PL'); }

    function buildItemId(mat, tier, enchant) {
      const base = MATERIAL_BASE_ID[mat];
      return enchant > 0 ? `T${tier}_${base}_LEVEL${enchant}@${enchant}` : `T${tier}_${base}`;
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchAvg24hMinus5(itemId, city) {
      const encCity = encodeURIComponent(city);
      try {
        const urlHist = `${API_HOST}/api/v2/stats/history/${itemId}.json?locations=${encCity}&time-scale=1`;
        const hist = await fetchJSON(urlHist);
        const first = Array.isArray(hist) ? hist[0] : null;
        const series = first && Array.isArray(first.data) ? first.data : [];
        const last24 = series.slice(-24).map(d => Number(d?.avg_price ?? d?.price ?? 0)).filter(x => x > 0);
        if (last24.length > 0) {
          const avg = last24.reduce((a,b)=>a+b,0) / last24.length;
          return Math.round(avg * 0.95);
        }
      } catch {}
      try {
        const urlNow = `${API_HOST}/api/v2/stats/prices/${itemId}.json?locations=${encCity}`;
        const now = await fetchJSON(urlNow);
        const obj = Array.isArray(now) ? now[0] : null;
        const min = Number(obj?.sell_price_min ?? 0);
        if (min > 0) return Math.round(min * 0.95);
      } catch {}
      return 0;
    }

    async function pLimitAll(tasks, limit = 8, onProgress = null) {
      let idx = 0, done = 0, results = new Array(tasks.length);
      const runners = new Array(Math.min(limit, tasks.length)).fill(0).map(async () => {
        while (true) {
          const i = idx++;
          if (i >= tasks.length) break;
          try { results[i] = await tasks[i](); }
          catch { results[i] = undefined; }
          done++;
          if (onProgress) onProgress(done, tasks.length);
        }
      });
      await Promise.all(runners);
      return results;
    }

    async function fetchPricesAll() {
      const loadStatus = document.getElementById("load-status");
      const loadProgress = document.getElementById("load-progress");
      const subheader = document.getElementById("subheader");
      loadStatus.textContent = "Ładowanie…"; loadStatus.className = "badge"; loadProgress.value = 0; loadProgress.max = 1;

      const jobs = [];
      for (const mat of Object.keys(materialCities)) {
        for (const tier of TIERS) {
          for (const ench of ENCHANTS) {
            const key = `${tier}.${ench}`;
            const city = materialCities[mat];
            const itemId = buildItemId(mat, tier, ench);
            jobs.push(async () => {
              const price = await fetchAvg24hMinus5(itemId, city);
              materialsPrices[mat][key] = price;
              return { mat, key, price };
            });
          }
        }
      }

      const total = jobs.length;
      loadProgress.max = total;
      await pLimitAll(jobs, 8, (done) => { loadProgress.value = done; });

      lastUpdatedAt = new Date();
      const okCount = Object.values(materialsPrices).flatMap(o=>Object.values(o)).filter(v=>v>0).length;
      const txt = okCount > 0 ? `Ceny zaktualizowane (${okCount}/${total})` : "Brak danych z API — użyte wartości 0";
      loadStatus.textContent = txt;
      loadStatus.className = "badge " + (okCount === total ? "ok" : okCount > 0 ? "warn" : "err");
      document.getElementById("last-updated").textContent = lastUpdatedAt ? `Ostatnia aktualizacja: ${lastUpdatedAt.toLocaleString('pl-PL')}` : "";
      subheader.textContent = txt;
    }

    const itemSelect = document.getElementById("item");
    for (const item of Object.keys(itemsData)) {
      const opt = document.createElement("option"); opt.value = item; opt.textContent = item; itemSelect.appendChild(opt);
    }

    document.getElementById("calculate").addEventListener("click", () => {
      const itemName = itemSelect.value;
      const tier = document.getElementById("tier").value;
      const enchant = document.getElementById("enchant").value;
      const sellPrice = parseInt(document.getElementById("price").value) || 0;
      const amount = Math.max(1, parseInt(document.getElementById("amount").value) || 1);
      const returnRate = Math.max(0, Math.min(100, parseFloat(document.getElementById("returnRate").value) || 0));

      const item = itemsData[itemName];
      let rawCostPerOne = 0;
      const matsText = [], matsNeededForAmount = [];

      for (const mat of item.mats) {
        const key = `${tier}.${enchant}`;
        const unitPrice = materialsPrices[mat.type]?.[key] ?? 0;
        const qtyPerItem = mat.qty;
        rawCostPerOne += qtyPerItem * unitPrice;
        matsText.push(`${qtyPerItem} ${mat.type} (${toPL(unitPrice)} ea) = ${toPL(qtyPerItem * unitPrice)} silver`);
      }

      const effectiveCostPerOne = rawCostPerOne * (1 - returnRate / 100);
      for (const mat of item.mats) {
        const qtyNeeded = mat.qty * amount * (1 - returnRate / 100);
        matsNeededForAmount.push(`${qtyNeeded.toFixed(2)} ${mat.type}`);
      }

      const totalRawCostOne = Math.round(rawCostPerOne);
      const totalRawCostAmount = Math.round(rawCostPerOne * amount);
      const totalEffectiveCostAmount = Math.round(effectiveCostPerOne * amount);

      document.getElementById("craft-text").textContent =
        `Crafting one ${itemName} requires:\n${matsText.join("\n")}\n\n` +
        `Raw materials cost (1 item, before return) = ${toPL(totalRawCostOne)} silver.\n` +
        `Final raw mats cost (1 item, after return) = ${toPL(Math.round(effectiveCostPerOne))} silver.\n\n` +
        `Crafting ${amount} ${itemName} requires raw materials worth (before return): ${toPL(totalRawCostAmount)} silver.\n` +
        `Total effective cost after return for ${amount} items: ${toPL(totalEffectiveCostAmount)} silver.\n\n` +
        `Materials needed for ${amount} pcs (after return rate):\n${matsNeededForAmount.join("\n")}`;

      const profitPerOne = sellPrice - effectiveCostPerOne;
      const profitTotal = profitPerOne * amount;

      document.getElementById("profit-text").textContent =
        `Profit/loss on one ${itemName}: ${toPL(Math.round(profitPerOne))} silver.\n` +
        `Profit/loss on ${amount} ${itemName}: ${toPL(Math.round(profitTotal))} silver.`;

      document.getElementById("results").scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("refresh").addEventListener("click", fetchPricesAll);
    fetchPricesAll();
  </script>
</body>
</html>




